# .github/workflows/changelog-check.yml
name: Changelog Check

on:
    pull_request:
        branches: [develop]
    push:
        branches: [develop]

jobs:
    check-changelog:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0  # Fetch full history

            - name: Check if CHANGELOG.md was modified
              id: changelog-check
              run: |
                  # For PR events, compare against the target branch
                  if [ "${{ github.event_name }}" == "pull_request" ]; then
                      BASE_SHA="${{ github.event.pull_request.base.sha }}"
                      HEAD_SHA="${{ github.event.pull_request.head.sha }}"
                      echo "Checking PR commits from $BASE_SHA to $HEAD_SHA"
                  else
                      # For push events, compare with the previous commit
                      BASE_SHA="${{ github.event.before }}"
                      HEAD_SHA="${{ github.sha }}"
                      echo "Checking push commits from $BASE_SHA to $HEAD_SHA"
                  fi
                  
                  # Get all commit messages in the range
                  echo "Getting all commit messages in range..."
                  if [ "$BASE_SHA" == "0000000000000000000000000000000000000000" ]; then
                      # New branch, just check the latest commit
                      COMMIT_MESSAGES=$(git log -1 --pretty=format:"%B" "$HEAD_SHA")
                  else
                      COMMIT_MESSAGES=$(git log --pretty=format:"%B" "$BASE_SHA".."$HEAD_SHA")
                  fi
                  
                  # Check for bypass flag in ANY commit message
                  if echo "$COMMIT_MESSAGES" | grep -q "\[skip-changelog\]"; then
                      echo "? Changelog check bypassed via commit message"
                      echo "Found bypass flag in one of the commit messages"
                      echo "bypassed=true" >> $GITHUB_OUTPUT
                      exit 0
                  fi
                  
                  # Check if CHANGELOG.md was modified
                  if git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -q "^CHANGELOG.md$"; then
                      echo "? CHANGELOG.md has been modified - check passed"
                      echo "bypassed=false" >> $GITHUB_OUTPUT
                  else
                      echo "? CHANGELOG.md has not been modified"
                      echo ""
                      echo "Please update CHANGELOG.md with your changes."
                      echo "Alternatively, include [skip-changelog] in ANY commit message to bypass this check."
                      echo ""
                      echo "Commit messages checked:"
                      echo "$COMMIT_MESSAGES" | sed 's/^/  /'
                      echo "bypassed=false" >> $GITHUB_OUTPUT
                      exit 1
                  fi

            - name: Comment on PR (if applicable)
              if: github.event_name == 'pull_request' && failure()
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.issues.createComment({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body: '? **CHANGELOG.md Check Failed**\n\nPlease update `CHANGELOG.md` with your changes before merging.\n\nTo bypass this requirement, include `[skip-changelog]` in **any** commit message in this PR.'
                      })
