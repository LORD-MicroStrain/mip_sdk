# .github/workflows/changelog-check.yml
name: Changelog Check

on:
    # Run on a pull request to merge into the specified branches
    pull_request:
        branches:
            - develop
            - main
            - master
    # Pushes to develop and main/master require the changelog to be updated
    push:
        branches:
            - develop
            - main
            - master

env:
    CHANGELOG_FILENAME: "CHANGELOG.md"
    SKIP_KEYWORD: "skip-changelog"
    CHECK_FAIL_HEADER: "**${{ env.CHANGELOG_FILENAME }} Check Failed**"
    UPDATE_CHANGELOG_MESSAGE: "Please update ${{ env.CHANGELOG_FILENAME }} with your changes"
    BYPASS_OPTION_MESSAGE: "Alternatively, include ${{ env.SKIP_KEYWORD }} in ANY commit message to bypass this check"

jobs:
    check-changelog:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0  # Fetch full history

            - name: Check if ${{ env.CHANGELOG_FILENAME }} was modified or bypassed
              id: changelog-check
              run: |
                  if [ "${{ github.event_name }}" == "pull_request" ]; then
                       # For PR events, compare against the target branch
                      BASE_SHA="${{ github.event.pull_request.base.sha }}"
                      HEAD_SHA="${{ github.event.pull_request.head.sha }}"
                      echo "Checking PR commits from $BASE_SHA to $HEAD_SHA"
                  else
                      # For push events, compare with the previous commit
                      BASE_SHA="${{ github.event.before }}"
                      HEAD_SHA="${{ github.sha }}"
                      echo "Checking push commits from $BASE_SHA to $HEAD_SHA"
                  fi

                  # Get all commit messages in the range
                  echo "Getting all commit messages in range..."
                  if [ "$BASE_SHA" == "0000000000000000000000000000000000000000" ]; then
                      # New branch, just check the latest commit
                      COMMIT_MESSAGES=$(git log -1 --pretty=format:"%B" "$HEAD_SHA")
                  else
                      COMMIT_MESSAGES=$(git log --pretty=format:"%B" "$BASE_SHA".."$HEAD_SHA")
                  fi

                  # Check if ${{ env.CHANGELOG_FILENAME }} was modified
                  if git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -q "^${{ env.CHANGELOG_FILENAME }}$"; then
                      echo "âœ… ${{ env.CHANGELOG_FILENAME }} has been modified - check passed"
                      echo "bypassed=false" >> $GITHUB_OUTPUT
                  # Check for bypass flag in ANY commit message
                  elif echo "$COMMIT_MESSAGES" | grep -q "${{ env.SKIP_KEYWORD }}"; then
                      echo "âœ… Bypass flag found in a commit message - check passed"
                      echo "bypassed=true" >> $GITHUB_OUTPUT
                  else
                      echo "âŒ ${{ env.CHANGELOG_FILENAME }} has not been modified"
                      echo ""
                      echo "${{ env.UPDATE_CHANGELOG_MESSAGE }}."
                      echo "${{ env.BYPASS_OPTION_MESSAGE }}."
                      echo ""
                      echo "Commit messages checked:"
                      echo "$COMMIT_MESSAGES" | sed 's/^/  /'
                      echo "bypassed=false" >> $GITHUB_OUTPUT
                      exit 1
                  fi

            - name: Find and remove failure comment on PR (if applicable)
              if: github.event_name == 'pull_request' && always()
              uses: actions/github-script@v7
              with:
                script: |
                    // Find and delete any existing comments from this bot
                    const comments = await github.rest.issues.listComments({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                    });

                    // Filter for comments that contain our specific message pattern
                    const botComments = comments.data.filter(comment =>
                        comment.user.login === 'github-actions[bot]' &&
                        comment.body.includes(${{ env.CHECK_FAIL_HEADER }})
                    );

                    // Delete existing bot comments
                    for (const comment of botComments) {
                        await github.rest.issues.deleteComment({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            comment_id: comment.id,
                        });
                    }

            - name: Comment on PR of failure (if applicable)
              if: github.event_name == 'pull_request' && failure()
              uses: actions/github-script@v7
              with:
                  script: |
                      // Create the failure comment
                      github.rest.issues.createComment({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body: |
                            ðŸš¨ ${{ env.CHECK_FAIL_HEADER }}

                            ${{ env.UPDATE_CHANGELOG_MESSAGE }} before merging.

                            ${{ env.BYPASS_OPTION_MESSAGE }} for this PR.
                      })
